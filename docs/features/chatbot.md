# 산재 상담 챗봇 기능

## 개요

산업재해 전문 상담을 제공하는 AI 챗봇 기능입니다. n8n 워크플로우와 RAG(Retrieval-Augmented Generation) 기술을 활용하여 Supabase 벡터 데이터베이스에서 정확한 정보를 검색하고, 이를 바탕으로 전문적인 답변을 생성합니다.

## 주요 기능

### 1. 자연어 질문 및 답변
- **자유 형식 질문**: 사용자가 자연어로 질문 입력
- **마크다운 지원**: 답변에 마크다운 형식 지원 (제목, 리스트, 링크 등)
- **컨텍스트 인식**: 이전 대화 내용을 기반으로 맥락 있는 답변

### 2. RAG 기반 정보 검색
- **벡터 검색**: Supabase 벡터 데이터베이스에서 관련 정보 검색
- **정확한 정보 제공**: 공식 문서 및 정확한 정보만을 기반으로 답변
- **출처 추적**: 검색된 정보의 출처 추적 가능 (향후 구현 가능)

### 3. 세션 관리
- **사용자별 세션**: Clerk userId를 기반으로 세션 구분
- **대화 기록 유지**: 같은 세션 내에서 이전 대화 내용 유지
- **최근 질문**: 최근 질문 5개를 빠른 재질문 버튼으로 제공

### 4. 로딩 상태 표시
- **단계별 로딩**: 
  - "분석 중" (2초)
  - "검색 중" (5초)
  - "작성 중" (답변 완료까지)
- **타임아웃 처리**: 응답이 지연될 경우 타임아웃 메시지 표시

### 5. 추천 질문
- **초기 질문 제안**: 페이지 로드 시 자주 묻는 질문 3개 제시
- **빠른 질문**: 추천 질문 클릭으로 즉시 질문 가능

## 기술 구성

### 페이지 구조
```
app/chatbot/
└── page.tsx                    # 챗봇 페이지 (인증 필요)
```

### 주요 컴포넌트
```
components/rag-chatbot/
└── RagChatbot.tsx               # 메인 챗봇 컴포넌트
```

### API 엔드포인트
```
app/api/chatbot/
└── route.ts                     # n8n 웹훅 프록시
```

### 데이터 흐름

1. **질문 전송**
   ```
   사용자 질문 입력
   → RagChatbot.handleAsk()
   → /api/chatbot/route.ts 호출
   → n8n 웹훅으로 전송
   → n8n 워크플로우 실행
   ```

2. **n8n 워크플로우 처리**
   ```
   n8n 웹훅 수신
   → Supabase 벡터 검색 (RAG)
   → 관련 문서 검색
   → LLM (GPT/Gemini)에 컨텍스트와 질문 전달
   → 답변 생성
   → 클라이언트로 응답 반환
   ```

3. **답변 표시**
   ```
   n8n에서 응답 수신
   → 마크다운 파싱
   → 메시지 목록에 추가
   → UI에 표시
   ```

### 세션 관리

- **세션 ID**: Clerk `userId` 사용
- **대화 기록**: 클라이언트 측 상태로 관리 (`useState`)
- **최근 질문**: 최근 5개 질문을 배열로 저장

### 에러 처리

- **네트워크 에러**: 재시도 안내 메시지
- **타임아웃**: 30초 이상 응답 없을 경우 타임아웃 메시지
- **인증 에러**: 로그인 필요 안내

## 접근 권한

- **인증 필요**: 로그인한 사용자만 접근 가능
- **Clerk 인증**: `@clerk/nextjs`를 통한 인증 확인
- **미인증 시**: 홈 페이지로 리다이렉트

## 사용자 경험

### UI/UX 특징
- **대화형 인터페이스**: 사용자와 AI 메시지를 구분하여 표시
  - 사용자: 초록색 배경, 흰색 텍스트
  - AI: 회색 배경, 검은색 텍스트
- **큰 폰트**: 18px (text-lg)로 가독성 향상
- **넓은 줄 간격**: leading-relaxed (1.6)로 읽기 편함
- **반응형 디자인**: 모바일과 데스크톱 모두 최적화

### 인터랙션
- **Enter 키 전송**: 텍스트 영역에서 Enter 키로 전송 (Shift+Enter는 줄바꿈)
- **버튼 크기**: 모바일에서는 버튼 크기 조정
- **로딩 애니메이션**: RiuLoader 컴포넌트로 로딩 표시

## 주요 파일 경로

- **페이지**: `app/chatbot/page.tsx`
- **컴포넌트**: `components/rag-chatbot/RagChatbot.tsx`
- **API Route**: `app/api/chatbot/route.ts`
- **유틸리티**: `lib/utils/error-logging.ts`, `lib/utils/chatbot-analytics.ts`

## 환경 변수

- `NEXT_PUBLIC_N8N_WEBHOOK_URL`: n8n 웹훅 URL

## n8n 워크플로우 구성

### 주요 단계
1. **웹훅 수신**: Next.js에서 전송된 질문 수신
2. **Supabase 벡터 검색**: RAG를 통한 관련 문서 검색
3. **LLM 호출**: 검색된 컨텍스트와 질문을 LLM에 전달
4. **답변 생성**: LLM이 답변 생성
5. **응답 반환**: 생성된 답변을 Next.js로 반환

### RAG 벡터 데이터베이스
- **Supabase 벡터 확장**: `pgvector` 확장 사용
- **임베딩**: 문서를 벡터로 변환하여 저장
- **유사도 검색**: 질문과 유사한 문서 검색

## 향후 개선 가능 사항

- 대화 기록 저장 (데이터베이스)
- 대화 내보내기 기능 (PDF, 텍스트)
- 답변 평가 기능 (좋아요/싫어요)
- 답변 출처 표시 (어떤 문서에서 참조했는지)
- 음성 입력 지원
- 다국어 지원
- 전문 용어 사전 통합
- 챗봇 성능 분석 대시보드

