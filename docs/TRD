# TRD: 산재 환자 지원 플랫폼

## Technical Requirement Document

---

## 1. 문서 개요

### 1.1 문서 목적

이 문서는 리워크케어(ReWorkCare) MVP 버전의 기술적 구조, 시스템 구성, API 명세, 데이터 처리 및 보안 요구사항을 정의한다.

**목표**: 법적 리스크 없이 빠르게 개발 가능한 안정적 MVP 구조를 구축하는 것

---

## 2. 시스템 개요

### 2.1 아키텍처 요약

| 구성 요소 | 기술 스택 | 설명 |
|----------|----------|------|
| **Frontend** | Next.js (App Router) | React 기반 풀스택 프레임워크 |
| **Backend** | Supabase (PostgreSQL + Edge Functions) | 서버리스 백엔드 및 데이터베이스 |
| **Authentication** | Clerk | 사용자 인증 및 권한 관리 |
| **AI Integration** | OpenAI API (gpt-4-turbo) | AI 기반 서류 가이드 생성 |
| **Map Service** | Naver Map API | 위치 기반 병원 정보 시각화 |
| **Data Source** | 공공데이터포털(data.go.kr) | 산재 지정 의료기관 데이터 |
| **Hosting** | Vercel | 서버리스 프론트엔드 배포 |
| **Storage** | Supabase Storage | 이미지 및 캐시 데이터 저장 |

### 2.2 시스템 구성도

```mermaid
graph TB
    A[사용자 브라우저] --> B[Next.js Frontend]
    B --> C[Supabase DB/Auth]
    B --> D[OpenAI API]
    B --> E[Naver Maps API]
    B --> F[공공데이터포털 API]

    C --> G[사용자 데이터]
    C --> H[병원 캐시 데이터]

    D --> I[AI 요약 가이드]
    E --> J[지도 표시]
    F --> K[병원 정보 조회]
```

---

## 3. 기술 스택 상세

### 3.1 Frontend 레이어

| 구성 요소 | 기술 스택 | 버전 | 목적 |
|----------|----------|------|------|
| **Framework** | Next.js | 15.x | SEO 최적화, App Router 구조, SSR/SSG |
| **Language** | TypeScript | 5.x | 타입 안정성 및 개발 생산성 |
| **Styling** | Tailwind CSS | v4.x | 유틸리티 기반 반응형 디자인 |
| **UI Components** | shadcn/ui | latest | 접근성 높은 컴포넌트 라이브러리 |
| **Icons** | Lucide React | latest | 일관된 아이콘 시스템 |
| **State Management** | React Hooks + Context | - | 클라이언트 상태 관리 |

### 3.2 Backend & Infrastructure

| 구성 요소 | 기술 스택 | 목적 |
|----------|----------|------|
| **Backend** | Supabase | 인증, 데이터 저장, API 라우팅, Edge Functions |
| **Database** | PostgreSQL | 병원/약국 데이터 캐시, 사용자 로그 저장 |
| **Authentication** | Clerk | 소셜 로그인, 세션 관리, JWT 토큰 |
| **AI Integration** | OpenAI API | 서류 작성 가이드, 요약 문장 생성 |
| **Map Service** | Naver Maps API v3 | 위치 기반 병원 정보 시각화 |
| **Hosting** | Vercel | 프론트엔드 배포 및 Edge 네트워크 |
| **Monitoring** | Supabase Logs + Vercel Analytics | 트래픽 및 에러 모니터링 |
| **Storage** | Supabase Storage | 이미지 및 정적 파일 저장 |

### 3.3 개발 환경

| 도구 | 목적 |
|------|------|
| **Package Manager** | pnpm | 의존성 관리 및 빠른 설치 |
| **Linting** | ESLint | 코드 품질 유지 |
| **Testing** | Jest + React Testing Library | 단위/통합 테스트 |
| **Version Control** | Git | 소스 코드 관리 |

## 4. 데이터 구조

### 4.1 병원/약국 캐시 테이블

| 필드명 | 타입 | Null 허용 | 설명 |
|--------|------|-----------|------|
| `id` | `UUID` | ❌ | 기본 키 (Primary Key) |
| `name` | `TEXT` | ❌ | 병원명 또는 약국명 |
| `type` | `ENUM('hospital', 'pharmacy')` | ❌ | 시설 구분 |
| `address` | `TEXT` | ❌ | 전체 주소 |
| `latitude` | `FLOAT` | ❌ | 위도 (WGS84 좌표계) |
| `longitude` | `FLOAT` | ❌ | 경도 (WGS84 좌표계) |
| `phone` | `TEXT` | ✅ | 연락처 (전화번호) |
| `department` | `TEXT` | ✅ | 진료과목 (병원만 해당) |
| `last_updated` | `TIMESTAMPTZ` | ❌ | 마지막 업데이트 시간 |

**데이터 관리 정책:**
- **갱신 주기**: 24시간마다 공공데이터포털 API 호출하여 캐시 업데이트
- **인덱스**: `latitude`, `longitude`에 공간 인덱스 생성 (위치 검색 최적화)
- **RLS**: MVP 단계에서는 비활성화 (개발 편의성 우선)

### 4.2 사용자 활동 로그 테이블

| 필드명 | 타입 | Null 허용 | 설명 |
|--------|------|-----------|------|
| `id` | `UUID` | ❌ | 기본 키 |
| `user_id` | `UUID` | ✅ | Clerk 사용자 ID (익명 사용자 허용) |
| `action` | `TEXT` | ❌ | 액션 유형 (예: 'page_view', 'search', 'download') |
| `timestamp` | `TIMESTAMPTZ` | ❌ | 활동 발생 시간 |
| `meta` | `JSONB` | ✅ | 추가 메타데이터 (검색어, 클릭 항목 등) |

**로그 수집 목적:**
- 사용자 행동 패턴 분석
- 서비스 개선을 위한 데이터 기반 의사결정
- A/B 테스트 결과 측정

## 5. API 명세

### 5.1 내부 API (Next.js API Routes)

#### GET `/api/places` - 병원/약국 정보 조회

**목적**: 사용자 위치 기반 주변 산재 지정 의료기관 검색

**Query Parameters:**
- `lat` (required): 사용자 위도 (예: `37.5665`)
- `lng` (required): 사용자 경도 (예: `126.9780`)
- `radius` (optional): 검색 반경 (km), 기본값: `5`
- `type` (optional): 시설 유형 (`hospital` 또는 `pharmacy`), 기본값: 전체

**응답 형식:**
```json
{
  "success": true,
  "data": {
    "results": [
      {
        "id": "uuid",
        "name": "서울의료원",
        "type": "hospital",
        "address": "서울특별시 중랑구 신내로 156",
        "phone": "02-2276-7000",
        "latitude": 37.6,
        "longitude": 127.09,
        "department": "내과, 정형외과",
        "distance": 1.2
      }
    ],
    "total": 1
  }
}
```

**에러 응답:**
```json
{
  "success": false,
  "error": {
    "code": "INVALID_COORDINATES",
    "message": "유효하지 않은 좌표입니다."
  }
}
```

#### POST `/api/guide` - AI 서류 가이드 생성

**목적**: 특정 산재 서류에 대한 AI 기반 작성 가이드 생성

**요청 본문:**
```json
{
  "formName": "요양급여신청서",
  "content": "작성 항목별 설명을 요청"
}
```

**응답 형식:**
```json
{
  "success": true,
  "data": {
    "summary": "이 서류는 치료비 및 요양급여 청구를 위한 신청서입니다.",
    "fields": [
      {
        "name": "신청인 정보",
        "guide": "성명, 주민번호, 연락처를 입력합니다.",
        "required": true
      },
      {
        "name": "요양기관",
        "guide": "산재 승인 병원명을 입력합니다.",
        "required": true
      }
    ],
    "disclaimer": "※ 이 내용은 법률적/의학적 자문이 아니며, 참고용 정보입니다."
  }
}
```

**AI 모델 설정:**
- **모델**: `gpt-4-turbo`
- **Temperature**: `0.3` (안정적 문서 요약 중심)
- **Max Tokens**: `1000`
- **System Prompt**: 법적 책임 한계를 명확히 하는 프롬프트

## 6. AI 설계

### 6.1 MVP 단계 (현재 구현)

**접근 방식**: 단순 프롬프트 기반 요약형 가이드

**특징:**
- **프롬프트 엔지니어링**: 구조화된 프롬프트로 일관된 응답 생성
- **안정성 우선**: Temperature 0.3으로 변동성 최소화
- **법적 안전성**: 모든 응답에 면책 조항 포함

**예시 프롬프트:**
```
다음 산재 서류의 작성 방법을 일반인이 이해하기 쉽게 요약해주세요:
서류명: {서류명}
요청사항: {사용자 요청사항}

주의사항:
- 법률적/의학적 자문이 아님을 명확히 명시
- 근로복지공단 또는 전문가와 상담 권장
- 쉬운 용어 사용
```

### 6.2 확장 단계 (Phase 2+)

**접근 방식**: RAG (Retrieval-Augmented Generation) 구조 적용

**구성 요소:**
- **벡터 데이터베이스**: Supabase Vector Store 활용
- **학습 데이터**:
  - 근로복지공단 규정집 (PDF)
  - 산재 신청 서류 샘플
  - 판례 및 FAQ 데이터
- **임베딩 모델**: `text-embedding-3-large`
- **검색 파이프라인**: 사용자 질문 → 벡터 검색 → 관련 문서 추출 → AI 요약

**워크플로우:**
```mermaid
graph LR
    A[사용자 질문] --> B[벡터 검색]
    B --> C[관련 문서 추출]
    C --> D[AI 모델 요약]
    D --> E[답변 생성 + 출처 표기]
```

**장점:**
- 정확도 향상: 공식 문서 기반 답변
- 신뢰성 강화: 출처 투명성 확보
- 확장성: 새로운 문서 쉽게 추가 가능

## 7. 인증 및 보안

### 7.1 사용자 인증

| 항목 | 방식 | 설명 |
|------|------|------|
| **사용자 인증** | Clerk | 이메일/소셜 로그인, JWT 토큰 기반 세션 관리 |
| **권한 관리** | Clerk RBAC | 역할 기반 접근 제어 (사용자, 관리자 구분) |
| **세션 관리** | JWT + HttpOnly 쿠키 | XSS 공격 방지, 자동 만료 설정 |

### 7.2 데이터 보호

| 항목 | 방식 | 설명 |
|------|------|------|
| **데이터 암호화** | HTTPS (TLS 1.3) | 전송 중 암호화, MITM 공격 방지 |
| **API Key 보호** | `.env` 환경 변수 | 서버 사이드 전용, Gitignore 적용 |
| **데이터베이스 암호화** | Supabase 내장 | 저장 데이터 암호화 |
| **개인정보 저장** | 최소화 정책 | 이메일 외 개인정보 저장 금지 |

### 7.3 프라이버시 보호

| 항목 | 구현 방식 | 목적 |
|------|----------|------|
| **위치 데이터** | 비식별 처리 | 저장하지 않고 세션 내에서만 사용 |
| **IP 주소** | 마스킹 | 로그에서 마지막 옥텟 제거 |
| **사용자 추적** | 옵트인 동의 | 쿠키 배너 및 GDPR 준수 |
| **데이터 보존** | 최소 기간 | 법적 요구사항 외 불필요 데이터 삭제 |

---

## 8. 성능 및 확장성 요구사항

### 8.1 응답 시간 목표

| 항목 | 목표 | 측정 방법 | 우선순위 |
|------|------|----------|----------|
| **초기 페이지 로드** | 3초 이내 (모바일) | Lighthouse FCP | 🔴 Critical |
| **지도 로드 응답** | 2초 이내 | Performance API | 🔴 Critical |
| **API 응답 시간** | < 500ms | Network 탭 | 🟡 High |
| **AI 가이드 생성** | < 3초 | Client 측정 | 🟡 High |

### 8.2 확장성 요구사항

| 항목 | 목표 | 구현 방식 |
|------|------|----------|
| **동시 접속 처리** | 1,000명 이상 | Supabase Edge Functions 자동 확장 |
| **서버 확장성** | Auto-scaling | Vercel + Supabase Serverless 구조 |
| **데이터베이스** | 10,000+ 읽기/초 | Supabase 자동 확장 + 인덱싱 |
| **캐시 전략** | 90%+ 히트율 | Redis/Supabase 캐시 + CDN |

### 8.3 모니터링 지표

- **가용성**: 99.5% 이상 월간 uptime
- **에러율**: 0.1% 미만 사용자당 일일 에러
- **성능**: Core Web Vitals 준수 (Lighthouse 90+ 점)

---

## 9. 운영 및 배포

### 9.1 배포 파이프라인

| 항목 | 방식 | 설명 |
|------|------|------|
| **CI/CD** | GitHub Actions → Vercel | 자동화된 배포 파이프라인 |
| **브랜치 전략** | Git Flow | `main/dev/feature` 브랜치 분리 |
| **환경** | 개발/스테이징/프로덕션 | 환경별 설정 분리 |

### 9.2 데이터베이스 운영

| 항목 | 방식 | 주기 |
|------|------|------|
| **자동 백업** | Supabase 내장 | 매일 자동 백업 |
| **모니터링** | Supabase Dashboard | 실시간 성능 모니터링 |
| **마이그레이션** | Supabase CLI | 버전 관리된 스키마 변경 |

### 9.3 모니터링 및 로깅

| 항목 | 도구 | 목적 |
|------|------|------|
| **애플리케이션 모니터링** | Vercel Analytics | 사용자 행동 추적 |
| **에러 추적** | Vercel Error Monitoring | 실시간 에러 알림 |
| **로그 수집** | Supabase Logs | 시스템 로그 중앙화 |
| **알림** | Slack Webhook | 긴급 상황 자동 알림 |

### 9.4 테스트 전략

| 테스트 유형 | 도구 | 범위 |
|-----------|------|------|
| **단위 테스트** | Jest + React Testing Library | 컴포넌트 및 유틸리티 함수 |
| **통합 테스트** | Jest + Supertest | API 엔드포인트 |
| **E2E 테스트** | Playwright | 전체 사용자 플로우 |

---

## 10. 유지보수 및 개선 로드맵

### 10.1 기술 발전 단계

| 기간 | 주요 기술 개선 | 목표 |
|------|----------------|------|
| **0~3개월 (MVP)** | 기본 인프라 구축, 병원 API 연동 | 안정적 서비스 런칭 |
| **3~6개월 (Phase 1.5)** | AI 가이드 고도화, 서류 자동 요약 | 사용자 경험 개선 |
| **6~12개월 (Phase 2)** | RAG 챗봇 도입, 캐시 최적화 | 지능형 서비스 전환 |
| **1년 이후 (Phase 3)** | ML 기반 추천, 개인화 서비스 | 생태계 확장 |

### 10.2 유지보수 활동

#### 매주
- **보안 패치**: 의존성 라이브러리 업데이트
- **모니터링 리뷰**: 에러 로그 및 성능 지표 분석
- **사용자 피드백**: 설문조사 및 리뷰 분석

#### 매월
- **성능 최적화**: Lighthouse 점수 모니터링 및 개선
- **데이터베이스 튜닝**: 쿼리 최적화 및 인덱스 조정
- **콘텐츠 업데이트**: 병원 정보 및 서류 가이드 최신화

#### 분기별
- **기술 스택 검토**: 새로운 기술 도입 검토
- **아키텍처 리뷰**: 확장성 및 유지보수성 평가
- **사용자 리서치**: 심층 인터뷰 및 사용성 테스트

---

## 11. 기술 리스크 및 대응

### 11.1 주요 기술 리스크

| 리스크 | 심각도 | 설명 | 대응 방안 |
|--------|--------|------|----------|
| **공공데이터 API 불안정** | 🟡 Medium | `data.go.kr` 서버 응답 지연 또는 장애 가능 | Supabase 캐시 DB 운영, 다중 백업 전략 |
| **OpenAI API 비용 증가** | 🟡 Medium | 트래픽 증가 시 비용 급증 가능 | LLM 호출 제한 + 응답 캐싱 적용 |
| **법적 해석 문제** | 🔴 High | AI가 법률 해석처럼 보일 위험 | "참고용 정보" 문구 필수 표기, 면책 조항 강조 |
| **개인정보 유출** | 🔴 High | 위치 데이터 및 사용자 정보 유출 위험 | 위치 비저장 정책 준수, 최소 정보 수집 |
| **지도 API 제한** | 🟡 Medium | Naver Maps API 호출 제한 초과 가능 | 캐싱 전략 + 사용자별 제한 적용 |
| **AI 응답 품질** | 🟡 Medium | 부정확한 정보 제공 가능성 | 프롬프트 엔지니어링 + 품질 검증 프로세스 |

### 11.2 리스크 모니터링

#### 조기 경보 시스템
- **API 응답 시간 모니터링**: 500ms 초과 시 알림
- **에러율 모니터링**: 5% 초과 시 긴급 대응
- **비용 모니터링**: 월별 AI API 사용량 추적

#### 대응 프로세스
1. **모니터링**: 실시간 대시보드로 리스크 지표 추적
2. **평가**: 주기적 리스크 평가 및 우선순위 설정
3. **대응**: 사전 정의된 대응 방안 실행
4. **후속조치**: 인시던트 리뷰 및 개선안 도출

---

## 12. 품질 보증 (QA Plan)

### 12.1 테스트 전략

#### 기능 테스트
- **UI 동작 테스트**: 모든 버튼, 링크, 폼 정상 작동 확인
- **지도 표시 테스트**: 병원 핀 표시 및 클릭 인터랙션 검증
- **검색 정확도 테스트**: 위치 기반 검색 결과 정합성 확인
- **반응형 디자인 테스트**: 모바일/태블릿/데스크톱 환경별 확인

#### 성능 테스트
- **병원 검색 성능**: 1,000건 데이터 검색 시 < 2초 응답
- **지도 로딩 성능**: 초기 로드 < 3초, 인터랙션 < 1초
- **메모리 누수 테스트**: 장시간 사용 시 메모리 사용량 모니터링
- **네트워크 효율성**: API 호출 최적화 및 캐시 히트율 측정

#### 보안 테스트
- **Clerk 인증 테스트**: 세션 유효성 및 권한 제어 확인
- **API 보안 테스트**: 인가되지 않은 접근 차단 검증
- **데이터 암호화**: 민감 정보 암호화 상태 확인
- **취약점 스캔**: 정기적 보안 취약점 검사

### 12.2 AI 품질 테스트

#### 정확도 평가 기준
- **응답 정확도**: 80% 이상의 신뢰할 수 있는 정보 제공
- **완전성**: 필수 정보 누락 없이 포괄적 안내
- **명확성**: 일반인이 이해하기 쉬운 용어 사용
- **안전성**: 법적 리스크 유발 정보 배제

#### 테스트 방법
- **단위 테스트**: 개별 프롬프트 응답 품질 평가
- **통합 테스트**: 전체 서류 가이드 플로우 검증
- **사용자 테스트**: 실제 사용자 피드백 수집 및 개선

### 12.3 품질 게이트

#### 개발 단계별 검증
- **코드 리뷰**: TypeScript 엄격 모드 준수 확인
- **단위 테스트**: 80% 이상 코드 커버리지 유지
- **통합 테스트**: 모든 API 엔드포인트 정상 작동 확인
- **E2E 테스트**: 크리티컬 사용자 플로우 자동화 검증

#### 배포 전 필수 검증
- **성능 기준**: Lighthouse 점수 90+ 달성
- **보안 스캔**: 취약점 0건 유지
- **접근성**: WCAG 2.1 AA 준수 확인

---

## 13. 부록

### 13.1 환경 설정 파일 예시

#### `.env.example`
```bash
# Clerk Authentication
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...

# OpenAI
OPENAI_API_KEY=sk-...

# Naver Maps
NAVER_MAP_CLIENT_ID=xxx
NAVER_MAP_CLIENT_SECRET=xxx

# 공공데이터포털
DATA_GO_KR_API_KEY=xxx
```

### 13.2 주요 기술 문서 링크

- **Next.js 15**: https://nextjs.org/docs
- **Supabase**: https://supabase.com/docs
- **Clerk**: https://clerk.com/docs
- **OpenAI API**: https://platform.openai.com/docs
- **Naver Maps**: https://navermaps.github.io/maps.js.naver.com

### 13.3 API 엔드포인트 참조

#### 공공데이터포털 산재 의료기관 API
- **베이스 URL**: `http://apis.data.go.kr/`
- **엔드포인트**: `B551182/hospInfoServicev2/getHospBasisList`
- **인증 방식**: API Key 파라미터
- **응답 형식**: XML/JSON

#### Naver Maps API
- **베이스 URL**: `https://naveropenapi.apigw.ntruss.com/`
- **주요 엔드포인트**: 지도 표시, geocoding, reverse geocoding
- **제한**: 일 100,000 호출 (유료 플랜)

---

## 문서 정보

- **버전**: 1.0
- **최종 수정일**: 2025년 11월 13일
- **작성자**: 리워크케어(ReWorkCare) 개발팀
- **다음 검토일**: 2026년 2월 13일