# 약국 데이터 지오코딩 계획

## 📊 현재 상황

### 데이터 현황
- **총 약국 데이터**: 23,022개
- **지오코딩 필요**: 23,022개 (100%)
- **주소 정보**: 모두 보유 (100%)
- **주소 길이 분포**:
  - 보통 (20-40자): 19,620개 (85.2%) ✅
  - 짧음 (<20자): 2,383개 (10.3%) ✅
  - 길음 (40-60자): 1,015개 (4.4%) ⚠️
  - 매우길음 (60+자): 4개 (0.02%) ⚠️

### 기존 인프라
- ✅ 네이버 Geocoding API 클라이언트 (`lib/api/geocoding.ts`)
- ✅ VWorld Geocoding API 클라이언트 (백업용)
- ✅ 배치 처리 로직
- ✅ 병원 데이터 지오코딩 경험 (6,101개, 성공률 99.51%)

---

## 🎯 목표

1. **23,022개 약국 데이터의 주소를 위도/경도로 변환**
2. **성공률 95% 이상 달성** (병원 데이터 기준 99.51%)
3. **API Rate Limiting 준수** (네이버 API 제한)
4. **실패한 주소 재시도 메커니즘** (VWorld 백업)
5. **진행 상황 추적 및 재개 기능**

---

## 📋 단계별 계획

### 1단계: API 준비 및 테스트

#### 1.1 API 키 확인
- [ ] 네이버 Maps API 키 확인 (`NEXT_PUBLIC_NAVER_MAP_CLIENT_ID`, `NAVER_MAP_CLIENT_SECRET`)
- [ ] VWorld API 키 확인 (백업용, 선택사항)

#### 1.2 테스트 지오코딩
- [ ] 샘플 약국 10개로 지오코딩 테스트
- [ ] 성공률 확인
- [ ] API 응답 시간 측정
- [ ] 에러 케이스 확인

**예상 소요 시간**: 10분

---

### 2단계: 배치 지오코딩 API 구현

#### 2.1 API 엔드포인트 생성
- [ ] `app/api/pharmacies/geocode-batch/route.ts` 생성
- [ ] 기존 병원 지오코딩 로직 참고 (`app/api/hospitals/geocode-batch/route.ts`)

#### 2.2 주요 기능
1. **좌표가 없는 약국 조회**
   ```sql
   SELECT id, name, address
   FROM hospitals_pharmacies
   WHERE type = 'pharmacy'
     AND latitude = 0 
     AND longitude = 0
   LIMIT {batchSize}
   ```

2. **네이버 Geocoding API 호출**
   - 배치 크기: 100개씩 (API 부하 고려)
   - 요청 간 딜레이: 150ms (Rate Limiting 방지)
   - 재시도 로직: 3회

3. **Supabase 업데이트**
   - 성공한 좌표만 업데이트
   - 실패한 주소는 로그 기록

4. **진행 상황 반환**
   - 성공/실패 개수
   - 다음 배치 시작 ID
   - 실패한 주소 목록

**예상 소요 시간**: 30분

---

### 3단계: 배치 처리 스크립트

#### 3.1 자동화 스크립트
- [ ] `scripts/geocode-pharmacies.js` 생성
- [ ] 배치 단위로 자동 호출
- [ ] 진행 상황 표시
- [ ] 실패한 주소 재시도

#### 3.2 주요 기능
1. **현재 상태 확인**
   - 지오코딩 필요한 약국 개수
   - 이미 완료된 개수

2. **배치 처리**
   - 100개씩 처리
   - 각 배치 간 2초 대기
   - 최대 20배치 (2,000개) 처리 후 일시 정지

3. **재개 기능**
   - 마지막 처리된 ID부터 재개
   - 실패한 주소만 재시도

**예상 소요 시간**: 20분

---

### 4단계: VWorld 백업 지오코딩

#### 4.1 실패한 주소 재시도
- [ ] 네이버 API 실패한 주소 조회
- [ ] VWorld API로 재시도
- [ ] 성공률 향상

**예상 소요 시간**: 20분

---

### 5단계: 검증 및 최종 확인

#### 5.1 데이터 검증
- [ ] 지오코딩 성공률 확인
- [ ] 좌표 유효성 검증 (한국 영역 내)
- [ ] 중복 좌표 확인

#### 5.2 통계 리포트
- [ ] 지역별 지오코딩 성공률
- [ ] 주소 길이별 성공률
- [ ] 실패한 주소 분석

**예상 소요 시간**: 15분

---

## ⏱️ 예상 소요 시간

| 단계 | 작업 | 예상 시간 |
|------|------|----------|
| 1단계 | API 준비 및 테스트 | 10분 |
| 2단계 | 배치 지오코딩 API 구현 | 30분 |
| 3단계 | 배치 처리 스크립트 | 20분 |
| 4단계 | VWorld 백업 지오코딩 | 20분 |
| 5단계 | 검증 및 최종 확인 | 15분 |
| **총계** | | **약 1시간 35분** |

---

## 📊 예상 성능

### 처리 속도
- **배치 크기**: 100개
- **요청 간 딜레이**: 150ms
- **배치당 소요 시간**: 약 15초 (100개 × 150ms)
- **전체 처리 시간**: 약 1시간 (23,022개 ÷ 100 × 15초)

### API 제한
- **네이버 Maps API**: 
  - 무료: 초당 10회 (QPS 10)
  - 유료: 초당 100회 (QPS 100)
- **현재 설정**: 150ms 딜레이 = 초당 약 6.7회 (안전)

### 성공률 예상
- **병원 데이터 기준**: 99.51%
- **약국 데이터 예상**: 95-98%
  - 주소 형식이 약간 다를 수 있음
  - 일부 약국은 상세 주소가 부정확할 수 있음

---

## 🔄 재시도 전략

### 1차: 네이버 Geocoding API
- 재시도 횟수: 3회
- 재시도 간격: 2초, 4초, 6초 (지수 백오프)

### 2차: VWorld Geocoding API
- 네이버 실패한 주소만 재시도
- 재시도 횟수: 2회

### 3차: 주소 정제 후 재시도
- 괄호 내용 제거
- 상세 주소 단순화
- 시/도 + 시/군/구만 사용

---

## 📝 진행 상황 추적

### 데이터베이스 필드 활용
- `last_updated`: 지오코딩 완료 시간 기록
- `latitude`, `longitude`: 좌표 저장

### 로그 파일
- 실패한 주소 목록 저장
- 재시도 필요 주소 목록

---

## ⚠️ 주의사항

1. **API Rate Limiting**
   - 네이버 API 무료 플랜: 초당 10회 제한
   - 150ms 딜레이로 안전하게 처리

2. **비용 고려**
   - 네이버 Maps API: 무료 플랜 사용 가능
   - VWorld API: 무료 (일일 10,000건 제한)

3. **데이터 품질**
   - 일부 주소는 정확하지 않을 수 있음
   - 상세 주소가 없는 경우 시/군/구 중심 좌표 사용

4. **중단 시 재개**
   - 마지막 처리된 ID 저장
   - 배치 단위로 재개 가능

---

## 🚀 실행 순서

1. **1단계**: API 테스트 (10개 샘플)
2. **2단계**: 배치 API 구현
3. **3단계**: 스크립트로 자동 처리 시작
4. **4단계**: 실패한 주소 VWorld로 재시도
5. **5단계**: 최종 검증 및 리포트

---

## 📈 성공 기준

- ✅ 지오코딩 성공률 95% 이상
- ✅ 모든 배치 처리 완료
- ✅ 좌표 유효성 검증 통과
- ✅ 실패한 주소 재시도 완료

---

## 🔗 참고 문서

- [Geocoding 프로세스 문서](./GEOCODING_PROCESS.md)
- [네이버 Maps API 문서](./naver-maps-api.md)
- [Geocoding 옵션 문서](./GEOCODING_OPTIONS.md)







